version: 2
jobs:
  hello_world:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - checkout
      - run: echo "A first hello"

  build_and_test:
    docker:
      # Specify the version you desire here
      - image: circleci/php:7.4-node-browsers

    steps:
      - checkout

      - run:
          name: "Prepare Environment"
          command: |
            sudo apt update
            sudo docker-php-ext-install zip
            composer global require "squizlabs/php_codesniffer=*"
            git clone https://github.com/wataridori/framgia-php-codesniffer.git ~/.composer/vendor/squizlabs/php_codesniffer/src/Standards/Framgia

      # Download and cache dependencies
      - restore_cache:
          keys:
            # "composer.lock" can be used if it is committed to the repo
            - v1-dependencies-{{ checksum "composer.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: "Install Dependencies"
          command: composer install -n --prefer-dist

      - save_cache:
          key: v1-dependencies-{{ checksum "composer.json" }}
          paths:
            - ./vendor

      # Run tests with phpunit
      - run:
          name: "Run Tests"
          command: ./vendor/bin/phpunit

      # Run tests!
      - run: sudo ~/.composer/vendor/bin/phpcs

  # deployment:
  #   docker:
  #     - image: circleci/php:7.2-browsers
  #   steps:
  #     - add_ssh_keys:
  #         fingerprints:
  #           - "59:43:6e:72:dc:75:53:ab:f3:e7:33:2a:05:98:46:a0"
  #     - checkout
  #     - run:
  #         name: Install Deployer
  #         command: |
  #           curl -LO https://deployer.org/deployer.phar
  #           sudo mv deployer.phar /usr/local/bin/dep
  #           sudo chmod +x /usr/local/bin/dep
  #     - run:
  #         name: Deploy
  #         command: |
  #           if [ -z `ssh-keygen -F '52.15.170.75'` ]; then
  #             ssh-keyscan -H '52.15.170.75' >> ~/.ssh/known_hosts
  #           fi

  #           dep deploy
  deployment:
    docker:
      - image: circleci/php:7.2-browsers
    steps:
      - add_ssh_keys:
          fingerprints:
            - "59:43:6e:72:dc:75:53:ab:f3:e7:33:2a:05:98:46:a0"
      - checkout
      - run:
          name: Install Deployer
          command: |
            wget http://rocketeer.autopergamene.eu/versions/rocketeer.phar
            sudo chmod +x rocketeer.phar
            sudo mv rocketeer.phar /usr/local/bin/rocketeer
      - run:
          name: Deploy
          command: |
            if [ -z `ssh-keygen -F '52.15.170.75'` ]; then
              ssh-keyscan -H '52.15.170.75' >> ~/.ssh/known_hosts
            fi

            rocketeer deploy --on=staging --no-interaction
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - hello_world
      - build_and_test
      - deployment:
          requires:
            - build_and_test
          filters:
            branches:
              only: master
